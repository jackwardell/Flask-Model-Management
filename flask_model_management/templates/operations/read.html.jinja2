{% extends 'base_table.html.jinja2' %}

{% block form_card %}
    <form id="filter-form">
        <div role="form" id="form-content">
            {% for fields in form.fields | batch(4) %}
                <div class="form-row d-flex justify-content-center">
                    {% for field in form.fields %}
                        <div class="form-group col-3">
                            {% if field.type == 'RadioField' %}
                                {{ field.label(class="col-form-label") }}:
                                <div class="text-center">
                                    {% for subfield in field %}
                                        <div class="form-check form-check-inline">
                                            {{ subfield(class="form-check-input") }}
                                            {{ subfield.label(class="form-check-label") }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ field.label(class="col-form-label") }}:
                                {{ field(class="form-control col-12") }}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        <div class="form-group text-center">
            {{ form.confirm(class="btn btn-primary", value="read") }}
        </div>
    </form>
{% endblock %}

{% block body %}
    <div class="container-fluid p-0 mb-5">
        <div class="card">
            <div class="card-body">
                <table class="table table-bordered table-striped" id="table">
                    <thead>
                    <tr>
                        {% for col in model.columns %}
                            <th>{% if col.primary_key %}<i data-feather="key"></i>{% endif %}{{ col.name }} [{{ col.type }}]</th>
                        {% endfor %}
                        <th>actions</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        var table = $("#table").DataTable({
            "ajax": {
                url: "{{ get_url(endpoints.table_operation_api, tablename=model.name) }}",
                type: "GET"
            },
            "columns": [
                {% for column in model.columns %}
                    {"data": "{{ column.name }}"},
                {% endfor %}
                {"data": "actions"}
            ],
            "columnDefs": [
                {
                    "render": function (data, type, row) {
                        console.log(row)
                        return row;
                    },
                    "targets": -1
                },
                {#{"visible": false, "targets": [3]}#}
            ]
        })

        function getFormData(formId, reset) {
            var formData = $("#" + formId + " :input")
                .filter(function (index, element) {
                    return $(element).val() != '';
                })
                .serialize();
            if (reset) {
                $("#" + formId).trigger("reset");
            }
            return formData
        }

        $("#confirm").on('click', function () {
            var formData = getFormData('filter-form', false)

            var success_alert = $("#success-alert")
            var failure_alert = $("#failure-alert")
            success_alert.hide()
            failure_alert.hide()

            $.ajax({
                url: '{{ get_url(endpoints.table_operation_api, tablename=model.name) }}',
                type: 'GET',
                data: formData,
                success: function (result) {
                    if (result.success) {
                        $("#success-text").text(result.message);
                        success_alert.show();
                        table.clear().draw();
                        table.rows.add(result.data).draw();
                    } else {
                        $("#failure-text").text(result.message);
                        failure_alert.show();
                    }
                }
            })
            return false;
        })
    </script>
{% endblock %}
